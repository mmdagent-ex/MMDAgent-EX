# 遠隔操作API (Plugin_Remote)

`MMDAgent-EX` を制御するコマンドメッセージの仕様。

## 仕様一覧

- メッセージは1つごとに改行 "\n" で区切ってテキストモードで送信
- `SNDで始まるパート` はパケットの長さを埋め込んでバイナリモードで送信
- 接続断ごとに初期値にリセット → 値設定系メッセージは新規接続ごとに送りなおし

```text
__AV_START
　遠隔操作開始フラグ。これを受け取った MMDAgent-EX は、以後 __AV_END が来るまで受信した情報に従って遠隔操作を行う。OpenFaceMSで遠隔操作開始のチェックボックスがONになったときに発される。

__AV_END
　遠隔操作終了フラグ。これを受け取った MMDAgent-EX は、以後 __AV_START が来るまで遠隔操作を中断する。OpenFaceMSで遠隔操作開始のチェックボックスがOFFになったときに発される。

__AV_RECALIBRATE
　顔の向きを再キャリブレーションする。__AV_START 時に、その時点の遠隔操作者の顔の向きを正面として向きのキャリブレーションが行われる。このコマンドはそのキャリブレーションのみを再実行する。

__AV_SETMODEL,モデルエイリアス
　遠隔操作の対象とするモデルの名前。これを受け取った MMDAgent-EX は、指定された名前で動作しているモデルを以降の遠隔操作対象とする。

__AVCONF_ALLOWFARCLOSEMOVE,値
　体の前後の動きをトレースするかどうかのフラグ。1ならトレースする、0なら無視する。独立に、0なら平均した回転量を両目に適用する。

__AVCONF_DISABLEAUTOLIP,{NO|ARKIT|AU|ARKIT+AU|ALWAYS}
　音声伝送時の伝送音声からの自動リップシンクを行わない場面の指定。デフォルトは `NO` 、つまりリップシンクを常に行う。

__AV_TRACK,x,y,z,rx,ry,rz,eyeLrx,eyeLry,eyeLrz,eyeRrx,eyeRry,eyeRrz,flag
　頭部動作のパラメータ。頭の移動量(x,y,z)と回転量(rx,ry,rz)のあと左目と右目の回転量。移動量の単位はミリ、回転量の単位はラジアン。
　flag は目の回転量がグローバルのときに1、ローカルの時に0を指定する（OpenFace では1, ARKit では0）

__AV_ARKIT,shape=rate,shape=rate,...
　ARKit のフェイストラッキングの shape 名とその強度 [0..1] の組の集合。この値と shapemap の内容をもとにアバターの表情が制御される。 __AV_AU とは併用しない。

__AV_AU,num=rate,num=rate,...
　Action Unit の番号（1～46）とその強度 [0..1] の組の集合。この値と shapemap で定義したマッピングをもとにアバターの表情が制御される。__AV_ARKIT とは併用しない。

__AV_ACTION,idx
　指定した対話アクションを再生する。アクションは番号(1から）で指定する。モデルでは shapemap で指定した対応モーションが再生される。

__AV_EXBONE,name,x,y,z,rx,ry,rz,rw,name,x,y,z,rx,ry,rz,rw,...
　任意ボーンの外部制御。nameで指定した名前に対応するボーンの移動量と回転量を指定する。単位はそれぞれミリとクォータニオン。ここで使われる名前 name と実際に操作するボーンの対応は、shapemap 内で "EXBONE_name ボーン名" のように指定する必要あり。複数の指定を1回で行える。

__AV_EXMORPH,name=rate,name=rate,...
　任意モーフの外部制御。nameで指定した名前に対応するモーフの強度を指定する。値は [0..1]。ここで使われる名前 name と実際に操作するモーフは、shapemap 内で "EXMORPH_name ボーン名" のように対応を指定する必要あり。

__AV_MESSAGE,string
　string をMMDAgent-EXの制御メッセージとして MMDAgent-EX 内へ送る。任意のメッセージを指定可能。

SNDSTRM
　以後のSNDパートを音声ストリームとみなし、VADを有効にする。（デフォルト））

SNDFILE
　以後のSNDパートをファイルチャンクとみなし、VAD を無効にする。音声ファイル送信は(1) SNDFILE送信、(2)SNDパートで音声データ送信、(3) SNDBRKS で終了信号送信、の３段階で行われる。

SNDBRKS
　送られてきている音声をここで区切る。

SNDから始まるパート
　音声データ。仕様は後述

```

## 基本モーション・対話アクション・トラッキング制御が同時に行われる場合の動作

対話アクションとフェイストラッキングで重なる制御はトラッキングが優先されます。具体的に言うと、対話アクション `__AV_ACTION` と フェイストラッキング（`__AV_ARKIT` あるいは `__AV_AU` による制御）が同じ区間に実行された場合、両者の制御が衝突しないボーン・モーフについてはそれぞれが同時に表示されますが、制御が衝突するモーフ・ボーンについては*トラッキング側が優先*されます。

音声による自動リップシンクとフェイストラッキングによる口形制御は重なります。音声とフェイストラッキングを療養する場合、デフォルトでは両方が重ねて実行されます。この挙動は `__AVCONF_DISABLEAUTOLIP` メッセージで変更できます。`__AVCONF_DISABLEAUTOLIP,NO` がデフォルトで、両方が重ねて実行されます。`__AVCONF_DISABLEAUTOLIP,ARKIT` とすると、`__AV_ARKIT` による制御を優先し、ARKit の信号が届いている間は音声による自動リップシンクを行いません。`__AVCONF_DISABLEAUTOLI,AU` は同様に AU による制御を音声より優先します。どちらの場合も音声よりフェイスを優先させたい場合は `__AVCONF_DISABLEAUTOLIP,ARKIT+AU` と指定します。`ALWAYS` を指定すると音声自動リップシンクを完全にOFFにします。

対話シナリオ（.FST）で実行される基本モーションはフェイストラッキングで常に上書きされます。
`__AV_ACTION` で実行される対話アクションは、 MMDAgent-EX 内部では以下の条件で重ね合わせ再生されます。

- エイリアス名は `__action`
- 全身ではなく部分モーションとして再生 (`PART`) （フレーム1以降に動作指定があるボーン・モーフのみ適用）
- ループせずに1回のみ再生（`ONCE`）
- スムージングは `ON`、リポジションは `OFF`
- 優先度は `0` （デフォルト）

## 音声伝送の仕様

音声データは以下で説明する方法でエンコードして、遠隔操作と同じソケットへ送り込みます。以下の `xxxx` は4桁の数字で、そのあとに続くデータ本体のバイト長を10進数4桁で表します。16kHz, 16bit, mono のデータのみです。長い音声を一括で送信すると遅延が発生するので、なるべく40ms分 (1280 Bytes) ぐらいの短いセグメントで区切って逐次送信してください。

```text
１パックあたり ヘッダ7byte+本体
   文字列 "SND"   1バイト目～3バイト目
   数値 "xxxx"    4バイト目～7バイト目, decimal
   音声データ本体 8バイト目～(xxxxの値 + 7) バイト目
```

MMDAgent-EX は、デフォルトでは、送り込まれてくるオーディオをマイク録音等の長時間ストリーミングメディアと想定し、送られてくるオーディオに対して音声区間検出を行って検出された音声区間を単位として処理を行います。音声ファイルを1単位として送り込む場合は、まず先に `SNDFILE\n` を一度送ってモードを切り替えてから、ファイルの中身を逐次 `SND` で転送してください。その際、ファイルの終端まで送信し終えたら `SNDBRKS\n` を送って入力終了をMMDAgent-EXに伝える。

## 遠隔操作用のモデル単位設定ファイル (.shapemap)

遠隔操作を行うためには、CGモデル(.pmd）ごとに、遠隔操作用のモーフ設定ファイル（.shapemap）を用意する必要があります。モーフ設定ファイル（.shapemap）は、OpenFaceMS等から送信されてくる姿勢や表情のコード、あるいは対話アクションの番号といった論理的な制御コマンドに対して、実際にモデルがどのようにふるまうかを指定するものです。このファイルはモデルファイル (`xxx.pmd`) と同じフォルダに `xxx.pmd.shapemap` という名前で置きます。遠隔操作に使うモデルには必ずこの .shapemap を定義してください。

設定ファイル (.shapemap) はテキストファイルで、中身は以下のようになっています。`#` で始まる行はコメントで無視されます。

```text
#### パラメータ
## 目の回転量の係数。小さいほど目の回転量が小さくなる
## PMDモデルではモデルごとに目の回転量が異なるのでこの値で調整
EYE_ROTATION_COEF 0.5

#### リップシンク用モーフ名
LIP_A あ
LIP_I い
LIP_U う
LIP_O お

#### リップシンク中に０にリセットするモーフ名のリスト
#### 上記で指定した以外の、口を開けるモーフを全て指定する
NOLIP え,おお~,ワ,えー,ああ,いい,叫び,あーれー,口わらい,mouth_a_geo_C,mouth_i_geo_C,mouth_u_geo_C,mouth_e_geo_C,mouth_o_geo_C,mouth_oh_geo_C,mouth_smile_geo_C,mouth_surprise_geo

#### トラッキング設定
## 頭と視線のトラッキング（__AV_TRACK）で制御するボーン名
## 複数指定した場合、左から順にモデル上を探して見つかったものを使う
TRACK_HEAD 頭
TRACK_NECK 首
TRACK_LEFTEYE 左目
TRACK_RIGHTEYE 右目
TRACK_BOTHEYE 両目
TRACK_BODY 上半身2,上半身２,上半身1,上半身
TRACK_CENTER センター

## __AV_AU 用の Action Unit 番号に対応するモーフ名。AU使用時に指定
## AU情報はregressionのみ使う 値域は[0..5.0]だが 1.0以上の値は 1 にまるめる
##  モーフ名 のみの場合、値をそのまま重みにマッピング
##  モーフ名 >閾値 の場合、値 < 閾値 なら 0.0,値 >= 閾値なら 1.0
##  モーフ名 係数 の場合、値に係数倍したものを重みにマッピング（係数はゼロ以上、負はNG）
##  モーフが複数のAUに対応付けられている場合は加算される
##  一つの AU で複数のモーフを動かす場合、対象モーフごとに指定する
##  ここに書かれていないAUは無視される
AU6 笑い >0.7
AU1 上 0.5
AU2 上 0.5
AU4 困る
AU5 見開き
AU12 にこり
AU45 まばたき
## モーフ調律集合：左から優先で重みが合計1になるよう事後調整
## 複数定義可能（最大30個）。1つあたり10種まで。
MORPH_TUNE 笑い まばたき

## __AV_ARKIT用の ARKit シェイプ名に対応するモーフ名。ARKit 使用時に指定
##  モーフ名 のみの場合、値をそのまま重みにマッピング
##  モーフ名 >閾値 の場合、値 < 閾値 なら 0.0,値 >= 閾値なら 1.0
##  モーフ名 係数 xの場合、値に係数倍したものを重みにマッピング（係数はゼロ以上、負はNG）
##  モーフが複数のシェイプに対応付けられている場合は加算される
##  1つのシェイプで複数のモーフを動かす場合、対象モーフごとに指定する
##  ここに書かれていないシェイプは無視される
eyeBlink_L まば左
eyeBlink_R まば右
browDown_L 困り左
browDown_R 困り右
browOuterUp_L 上
noseSneer_L 怒り左
noseSneer_R 怒り右
eyeWide_L 見開き
jawOpen ワ
mouthPucker う
mouthSmile_L にっこり
mouthShrugLower む

#### プリセットモーション指定。プリセットアクション使用時に設定
## __AV_ACTION に対応するモーションファイル名を指定
ACT0 wait.vmd
ACT1 joy.vmd
ACT38 ashamed.vmd

#### 個別制御の設定 それぞれ利用する場合に設定
## __AV_EXBONE で使用される name に対応するボーン名
## ボーンの記述方法は TRACK と同じ
#EXBONE_name ボーン名

## __AV_EXMORPH で使用される name に対応するフェイス名
## モーフの記述方法は AU や ARKIT と同じ
#EXMORPH_name モーフ名

```

## ".pmd.loadmessage" ファイルと ".pmd.deletemessage" ファイル (MSのみ)
